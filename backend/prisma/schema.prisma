generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  OWNER_ADMIN  // Company owner, full access
  EMPLOYEE     // Company employee
  CUSTOMER     // External customer, limited access
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum BoardType {
  GENERAL
  PROPERTY    // Property management template
  PROJECT     // Project template
  CRM         // Customer relationship template
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  STATUS
  PERSON
  MONEY
  FILE
  CHECKBOX
  DROPDOWN
  LINK
  EMAIL
  PHONE
  RATING
  TIMELINE
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMMENT
  MESSAGE_RECEIVED
  INVITE_RECEIVED
  BOARD_SHARED
  MENTION
  SYSTEM
}

enum OccupancyStatus {
  VACANT
  OCCUPIED
  RENOVATION
}

enum Currency {
  USD
  ILS
  EUR
  GBP
}

// ============================================
// CORE MODELS
// ============================================

// Workspace: Multi-tenant container
model Workspace {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  description   String?
  logoUrl       String?   @map("logo_url")
  defaultCurrency Currency @default(USD) @map("default_currency")
  settings      Json?     // Store workspace-specific settings
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  members       WorkspaceMember[]
  boards        Board[]
  invites       Invite[]
  messageThreads MessageThread[]

  @@map("workspaces")
}

// User
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  avatarUrl     String?   @map("avatar_url")
  phone         String?
  role          UserRole  @default(CUSTOMER)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  workspaces    WorkspaceMember[]
  assignedTasks TaskAssignment[]
  comments      Comment[]
  activities    ActivityLog[]
  sentMessages  Message[] @relation("SentMessages")
  notifications Notification[]
  createdInvites Invite[] @relation("CreatedInvites")
  createdBoards Board[] @relation("CreatedBoards")
  createdTasks  Task[] @relation("CreatedTasks")

  @@map("users")
}

// Workspace membership (many-to-many with role context)
model WorkspaceMember {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  userId      String    @map("user_id")
  role        UserRole  @default(CUSTOMER)
  joinedAt    DateTime  @default(now()) @map("joined_at")
  isActive    Boolean   @default(true) @map("is_active")

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

// Invite
model Invite {
  id          String       @id @default(uuid())
  workspaceId String       @map("workspace_id")
  email       String
  role        UserRole     @default(CUSTOMER)
  token       String       @unique
  status      InviteStatus @default(PENDING)
  invitedById String       @map("invited_by_id")
  expiresAt   DateTime     @map("expires_at")
  acceptedAt  DateTime?    @map("accepted_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User         @relation("CreatedInvites", fields: [invitedById], references: [id])

  @@index([email, status])
  @@map("invites")
}

// ============================================
// BOARD MODELS (Monday-like)
// ============================================

// Board
model Board {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  createdById String    @map("created_by_id")
  name        String
  description String?
  type        BoardType @default(GENERAL)
  color       String?   // Board accent color
  icon        String?   // Icon identifier
  isTemplate  Boolean   @default(false) @map("is_template")
  isPublic    Boolean   @default(false) @map("is_public") // Visible to all workspace members
  settings    Json?     // Board-specific settings
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("CreatedBoards", fields: [createdById], references: [id])
  groups      Group[]
  columns     Column[]
  boardMembers BoardMember[]

  @@index([workspaceId, isActive])
  @@map("boards")
}

// Board membership (who can see/edit the board)
model BoardMember {
  id        String   @id @default(uuid())
  boardId   String   @map("board_id")
  userId    String   @map("user_id")
  canEdit   Boolean  @default(true) @map("can_edit")
  createdAt DateTime @default(now()) @map("created_at")

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@map("board_members")
}

// Group (row groups in Monday)
model Group {
  id        String   @id @default(uuid())
  boardId   String   @map("board_id")
  name      String
  color     String?
  position  Int      @default(0)
  collapsed Boolean  @default(false)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([boardId, position])
  @@map("groups")
}

// Column (defines field types for the board)
model Column {
  id          String    @id @default(uuid())
  boardId     String    @map("board_id")
  name        String
  type        FieldType
  width       Int?      @default(150)
  position    Int       @default(0)
  settings    Json?     // Type-specific settings (e.g., dropdown options, status colors)
  isRequired  Boolean   @default(false) @map("is_required")
  isVisible   Boolean   @default(true) @map("is_visible")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  board       Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  values      TaskFieldValue[]

  @@index([boardId, position])
  @@map("columns")
}

// Task (items/rows)
model Task {
  id          String    @id @default(uuid())
  groupId     String    @map("group_id")
  createdById String    @map("created_by_id")
  name        String
  position    Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  group       Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdBy   User      @relation("CreatedTasks", fields: [createdById], references: [id])
  fieldValues TaskFieldValue[]
  assignments TaskAssignment[]
  comments    Comment[]
  activities  ActivityLog[]
  subTasks    SubTask[]

  @@index([groupId, position])
  @@map("tasks")
}

// Task field values (stores actual data for each column)
model TaskFieldValue {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  columnId  String   @map("column_id")
  value     Json     // Flexible value storage
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  column    Column   @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@unique([taskId, columnId])
  @@map("task_field_values")
}

// Sub-tasks (checklist items)
model SubTask {
  id          String    @id @default(uuid())
  taskId      String    @map("task_id")
  name        String
  isCompleted Boolean   @default(false) @map("is_completed")
  position    Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("sub_tasks")
}

// Task assignments
model TaskAssignment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignments")
}

// ============================================
// COMMENTS & ACTIVITY
// ============================================

model Comment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@map("comments")
}

model ActivityLog {
  id        String   @id @default(uuid())
  taskId    String?  @map("task_id")
  userId    String   @map("user_id")
  action    String   // 'created', 'updated', 'moved', 'assigned', etc.
  details   Json?    // Additional context
  createdAt DateTime @default(now()) @map("created_at")

  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
  @@map("activity_logs")
}

// ============================================
// MESSAGING
// ============================================

model MessageThread {
  id          String    @id @default(uuid())
  workspaceId String    @map("workspace_id")
  title       String?
  isGroup     Boolean   @default(false) @map("is_group")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  participants ThreadParticipant[]
  messages    Message[]

  @@map("message_threads")
}

model ThreadParticipant {
  id        String   @id @default(uuid())
  threadId  String   @map("thread_id")
  userId    String   @map("user_id")
  lastReadAt DateTime? @map("last_read_at")
  joinedAt  DateTime @default(now()) @map("joined_at")

  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@map("thread_participants")
}

model Message {
  id        String   @id @default(uuid())
  threadId  String   @map("thread_id")
  senderId  String   @map("sender_id")
  content   String
  isEdited  Boolean  @default(false) @map("is_edited")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender    User          @relation("SentMessages", fields: [senderId], references: [id])

  @@index([threadId, createdAt])
  @@map("messages")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String?
  link      String?          // URL to navigate to
  isRead    Boolean          @default(false) @map("is_read")
  data      Json?            // Additional context
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}
